<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Streaming NDJSON Viewer</title>
<style>
  body { font-family: monospace; margin: 20px; }
  #table { border-collapse: collapse; width: 100%; }
  #table th, #table td { border: 1px solid #ccc; padding: 5px; }
  #table tbody tr:nth-child(even) { background-color: #f9f9f9; }
  #loader { margin: 10px 0; color: #555; }
</style>
</head>
<body>

<h1>ba_docume001 Viewer</h1>
<div id="loader">Caricamento in corso...</div>
<table id="table">
  <thead>
    <tr id="headerRow"></tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
async function streamNDJSON() {
  const response = await fetch('http://localhost:3000/api/v1/ba_docume001/stream-ndjson', {
    headers: { 'Authorization': eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsInVzZXJuYW1lIjoiYWRtaW4iLCJpYXQiOjE3NjgyMDgyMzYsImV4cCI6MTc2ODIzNzAzNn0.NQWZxTMdwt9rD5qxyS-lagQXWDq6yh0hSiQC_1ErXRQ }
  });

  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  let buffer = '';
  let rowsRendered = 0;
  const tableBody = document.getElementById('tableBody');
  const loader = document.getElementById('loader');
  const headerRow = document.getElementById('headerRow');
  
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;

    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split('\n');
    buffer = lines.pop(); // ultimo pezzo rimane per il prossimo chunk

    for (const line of lines) {
      if (!line) continue;
      const row = JSON.parse(line);

      // Crea intestazione dinamica se non esiste
      if (rowsRendered === 0) {
        Object.keys(row).forEach(key => {
          const th = document.createElement('th');
          th.textContent = key;
          headerRow.appendChild(th);
        });
      }

      const tr = document.createElement('tr');
      Object.values(row).forEach(val => {
        const td = document.createElement('td');
        td.textContent = val;
        tr.appendChild(td);
      });
      tableBody.appendChild(tr);

      rowsRendered++;

      // Virtual scroll: mostra solo i primi 200 record
      if (rowsRendered > 200) {
        tableBody.removeChild(tableBody.firstChild);
      }
    }
  }

  loader.textContent = `Caricati ${rowsRendered} record`;
}

streamNDJSON();
</script>

</body>
</html>
